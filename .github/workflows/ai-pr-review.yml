name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "categories/**/*.yml"
      - "categories/**/*.yaml"
      - "sites/**/*.yml"
      - "sites/**/*.yaml"
      - "schema/**"
      - "ai/**"
      - ".github/scripts/**"
      - ".github/submissions.txt"

permissions:
  contents: write          # needed for generating and committing site files
  pull-requests: write     # comment on PR
  issues: write            # sometimes needed for comments depending on org settings

concurrency:
  group: ai-pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  generate-site:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR HEAD branch (not merge commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.BOT_PAT }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema requests

      - name: Validate PR format
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/validate_pr_format.py

      - name: Generate site files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ENABLE_URL_FETCH: "true"
        run: |
          python .github/scripts/generate_site_from_url.py

      - name: Commit and push generated files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          # Check if submissions.txt exists and has URLs - if not, verify this is a safe second run
          if [ ! -f ".github/submissions.txt" ]; then
            echo "No submissions.txt file found. Checking if this is a safe second run..."
            
            # If generated_sites.txt exists, the script just ran and generated files (same workflow run)
            if [ -f ".github/generated_sites.txt" ]; then
              echo "✅ No submissions.txt, but generated_sites.txt exists (script just ran), proceeding with commit"
              # Continue with the commit process below
            else
              # No submissions.txt and no generated_sites.txt - check if this is a safe second run
              # Get the base commit to compare against
              BASE=$(git merge-base origin/main HEAD)
              
              # Check if there are any new site files in this PR (committed)
              NEW_SITE_FILES=$(git diff --name-only --diff-filter=A "${BASE}...HEAD" | grep -E '^sites/[^/]+/site\.yml$' || true)
              
              if [ -n "$NEW_SITE_FILES" ]; then
                # There are new site files - verify the latest commit was from the bot
                LATEST_COMMIT_AUTHOR=$(git log -1 --format='%an')
                LATEST_COMMIT_EMAIL=$(git log -1 --format='%ae')
                
                if [ "$LATEST_COMMIT_AUTHOR" = "web-atlas-bot" ] && [ "$LATEST_COMMIT_EMAIL" = "web-atlas-bot@users.noreply.github.com" ]; then
                  echo "✅ No submissions.txt, but latest commit is from bot (safe second run), skipping commit"
                  exit 0
                else
                  echo "❌ Security issue: No submissions.txt found, but new site files exist and latest commit is NOT from bot"
                  echo "Latest commit author: $LATEST_COMMIT_AUTHOR <$LATEST_COMMIT_EMAIL>"
                  echo "New site files detected:"
                  echo "$NEW_SITE_FILES"
                  echo "All site files must be submitted via .github/submissions.txt for security validation."
                  exit 1
                fi
              else
                # No new site files, safe to skip
                echo "No submissions.txt and no new site files, skipping commit"
                exit 0
              fi
            fi
          fi
          
          # Check if submissions.txt has any URLs (non-empty, non-comment lines)
          if ! grep -v '^[[:space:]]*#' .github/submissions.txt | grep -q '[^[:space:]]'; then
            echo "No URLs in submissions.txt (already processed in previous run), skipping commit"
            exit 0
          fi
          
          if [ ! -f ".github/generated_sites.txt" ]; then
            echo "No generated files, skipping commit"
            exit 0
          fi

          git config --local user.email "web-atlas-bot@users.noreply.github.com"
          git config --local user.name "web-atlas-bot"

          echo "Generated files list:"
          cat .github/generated_sites.txt || true

          # Always add the generated list (it's currently untracked)
          git add .github/generated_sites.txt
          
          # Also add/remove submissions.txt if it was modified (script may have removed URLs or deleted the file)
          if [ -f ".github/submissions.txt" ]; then
            git add .github/submissions.txt
          elif git ls-files --error-unmatch .github/submissions.txt >/dev/null 2>&1; then
            # File was deleted, stage the deletion
            git add .github/submissions.txt
          fi

          # Add each generated file listed (strip CRLF!)
          files_added=0
          echo "Reading files from .github/generated_sites.txt:"
          while IFS= read -r raw || [ -n "$raw" ]; do
            # Strip carriage returns and trim whitespace
            file="$(printf '%s' "$raw" | tr -d '\r\n' | xargs)"
            if [ -z "$file" ]; then
              echo "Skipping empty line"
              continue
            fi
            echo "Processing file path: '$file'"
            if [ -f "$file" ]; then
              echo "  ✓ File exists"
              # Check git status of file
              if git diff --quiet "$file" 2>/dev/null; then
                echo "  ⚠ File exists but git diff shows no changes"
                echo "  Checking if file is tracked:"
                if git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
                  echo "  ✓ File is tracked"
                  echo "  Force adding file anyway..."
                else
                  echo "  ⚠ File is not tracked"
                  echo "  Adding as new file..."
                fi
              else
                echo "  ✓ File has changes according to git diff"
              fi
              # Add the file
              if git add -f "$file"; then
                echo "  ✓ git add command succeeded"
                # Verify it was staged by checking if it appears in staged changes
                if git diff --cached --name-only | grep -q "^$file$"; then
                  echo "  ✓ File successfully staged (appears in staged changes)"
                  files_added=$((files_added + 1))
                else
                  echo "  ⚠ git add succeeded but file not in staged changes list"
                  echo "  Checking git status for this file:"
                  git status -- "$file" || true
                fi
              else
                echo "  ❌ git add failed for: $file"
              fi
            else
              echo "  ❌ File not found: '$file'"
              echo "  Current directory: $(pwd)"
              echo "  Listing sites directory:"
              ls -la sites/ 2>&1 | head -20 || true
            fi
          done < .github/generated_sites.txt
          
          echo ""
          echo "Files processed: $files_added"
          echo "Git status after staging:"
          git status
          echo ""
          echo "Staged changes:"
          git diff --cached --stat || echo "No staged changes"

          # Check if we have staged changes (excluding generated_sites.txt and submissions.txt)
          if git diff --cached --quiet -- . ':!.github/generated_sites.txt' ':!.github/submissions.txt'; then
            echo "❌ No staged changes for site files (only generated_sites.txt or submissions.txt was staged)"
            echo "This means the site files were not actually modified by the script."
            exit 1
          fi

          git commit -m "chore: AI generate site.yml from URL submissions"

          # Push explicitly to the PR branch (avoids ambiguity)
          git push origin "HEAD:${PR_BRANCH}"
          echo "✅ Successfully committed and pushed generated site files"

  review:
    runs-on: ubuntu-latest
    needs: generate-site  # Wait for site generation to complete
    
    steps:
      - name: Checkout PR HEAD branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema requests

      - name: Run AI reviewer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # mode can be: comment-only | autofix
          REVIEW_MODE: comment-only
          # set true later when you're confident
          ENABLE_AUTOMERGE: "false"
          # Optional: disable network checks if you want deterministic CI
          ENABLE_URL_FETCH: "true"
        run: |
          python .github/scripts/ai_pr_review.py

      # Optional step: enable auto-merge once you trust the system
      - name: Auto-merge (optional)
        if: env.ENABLE_AUTOMERGE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Merge only if the bot marked it as OK by creating this file.
          if [ -f ".github/ai_review/APPROVED" ]; then
            echo "Approved by AI, enabling merge."
          else
            echo "Not approved, skipping merge."
            exit 0
          fi
